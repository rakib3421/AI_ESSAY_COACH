{% extends "base.html" %}

{% block title %}Enhanced Analytics - AI Essay Revision{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header" style="background-color: #1e2839; color: white;">
                <h6 class="mb-0"><i class="fas fa-bars me-2"></i>Navigation</h6>
            </div>
            <div class="list-group list-group-flush">
                <a href="{{ url_for('teacher_dashboard') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </a>
                <a href="{{ url_for('view_submissions') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-file-alt me-2"></i>View Submissions
                </a>
                <a href="{{ url_for('create_assignment') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-plus me-2"></i>Create Assignment
                </a>
                <a href="{{ url_for('student_management') }}" class="list-group-item list-group-item-action">
                    <i class="fas fa-users me-2"></i>Manage Students
                </a>
                <a href="{{ url_for('teacher_analytics') }}" class="list-group-item list-group-item-action active">
                    <i class="fas fa-chart-line me-2"></i>Analytics
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-lg-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 style="color: #1e2839;">Enhanced Analytics Dashboard</h2>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="refreshAnalytics()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="exportAnalytics()">
                    <i class="fas fa-download me-2"></i>Export
                </button>
            </div>
        </div>

        <!-- KPI Widgets -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card analytics-card text-center">
                    <div class="card-body">
                        <div class="mb-2">
                            <i class="fas fa-users fa-2x text-primary"></i>
                        </div>
                        <h3 class="mb-1" style="color: #1e2839;">{{ overall_stats[2] or 0 }}</h3>
                        <p class="text-muted mb-0">Active Students</p>
                        <small class="text-success">
                            <i class="fas fa-arrow-up me-1"></i>
                            <span id="student-growth">+5.2%</span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card analytics-card text-center">
                    <div class="card-body">
                        <div class="mb-2">
                            <i class="fas fa-file-alt fa-2x text-success"></i>
                        </div>
                        <h3 class="mb-1" style="color: #1e2839;">{{ overall_stats[0] or 0 }}</h3>
                        <p class="text-muted mb-0">Total Essays</p>
                        <small class="text-info">
                            <i class="fas fa-clock me-1"></i>
                            <span id="essay-frequency">2.3 per week</span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card analytics-card text-center">
                    <div class="card-body">
                        <div class="mb-2">
                            <i class="fas fa-chart-line fa-2x text-warning"></i>
                        </div>
                        <h3 class="mb-1" style="color: #1e2839;">{{ "%.1f"|format(overall_stats[1] or 0) }}</h3>
                        <p class="text-muted mb-0">Average Score</p>
                        <small class="text-warning">
                            <i class="fas fa-equals me-1"></i>
                            <span id="score-trend">Stable</span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card analytics-card text-center">
                    <div class="card-body">
                        <div class="mb-2">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                        </div>
                        <h3 class="mb-1" style="color: #1e2839;" id="at-risk-count">0</h3>
                        <p class="text-muted mb-0">At-Risk Students</p>
                        <small class="text-danger">
                            <i class="fas fa-arrow-down me-1"></i>
                            <span>Below 60%</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- At-Risk Students Alert -->
        <div id="at-risk-alert" class="at-risk-indicator danger" style="display: none;">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Students Requiring Attention</h6>
            <div id="at-risk-list"></div>
        </div>

        <!-- Enhanced Charts Row -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card analytics-card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Performance Trends</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceTrendChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card analytics-card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-pie-chart me-2"></i>Essay Type Distribution</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="essayTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analytics -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card analytics-card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Rubric Dimension Performance</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="rubricDimensionChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card analytics-card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-users me-2"></i>Individual Student Progress</h6>
                    </div>
                    <div class="card-body">
                        <div id="student-progress-list" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <p class="small mt-2 mb-0">Loading student data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Engagement Metrics -->
        <div class="row">
            <div class="col-md-12">
                <div class="card analytics-card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Score Trends</h6>
                    </div>
                    <div class="card-body">
                        {% for date, avg_score in score_trends %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">{{ date.strftime('%B %d, %Y') if date else 'Unknown Date' }}</span>
                            <span class="badge bg-{{ 'success' if avg_score >= 80 else 'warning' if avg_score >= 60 else 'danger' }}">{{ "%.1f"|format(avg_score) }}</span>
                        </div>
                        {% endfor %}
                        {% if not score_trends %}
                        <p class="text-muted">No score data available yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize analytics dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeAnalyticsDashboard();
    loadAtRiskStudents();
    loadStudentProgressList();
});

function initializeAnalyticsDashboard() {
    // Performance Trend Chart
    const performanceCtx = document.getElementById('performanceTrendChart').getContext('2d');
    new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: [{% for date, avg_score in score_trends %}'{{ date.strftime("%m/%d") if date else "N/A" }}',{% endfor %}],
            datasets: [{
                label: 'Average Score',
                data: [{% for date, avg_score in score_trends %}{{ avg_score or 0 }},{% endfor %}],
                borderColor: '#1e2839',
                backgroundColor: 'rgba(30, 40, 57, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Essay Type Distribution Chart
    const essayTypeCtx = document.getElementById('essayTypeChart').getContext('2d');
    new Chart(essayTypeCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for essay_type, count in essay_types %}'{{ essay_type.title() }}',{% endfor %}],
            datasets: [{
                data: [{% for essay_type, count in essay_types %}{{ count }},{% endfor %}],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Rubric Dimension Chart
    const rubricCtx = document.getElementById('rubricDimensionChart').getContext('2d');
    new Chart(rubricCtx, {
        type: 'radar',
        data: {
            labels: ['Ideas', 'Organization', 'Style', 'Grammar'],
            datasets: [{
                label: 'Class Average',
                data: [75, 72, 78, 68], // These would be calculated from real data
                borderColor: '#1e2839',
                backgroundColor: 'rgba(30, 40, 57, 0.2)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

async function loadAtRiskStudents() {
    try {
        // This would be implemented to load actual at-risk student data
        const atRiskStudents = [];
        
        document.getElementById('at-risk-count').textContent = atRiskStudents.length;
        
        if (atRiskStudents.length > 0) {
            document.getElementById('at-risk-alert').style.display = 'block';
            const alertList = document.getElementById('at-risk-list');
            alertList.innerHTML = atRiskStudents.map(student => 
                `<div class="mb-2">
                    <strong>${student.name}</strong> - Average: ${student.average}%
                    <a href="/teacher/students/${student.id}/analytics" class="btn btn-sm btn-outline-primary ms-2">
                        View Details
                    </a>
                </div>`
            ).join('');
        }
    } catch (error) {
        console.error('Error loading at-risk students:', error);
    }
}

async function loadStudentProgressList() {
    const container = document.getElementById('student-progress-list');
    
    try {
        // This would load actual student progress data
        const students = [
            { name: 'Sample Student', recent_score: 85, trend: 'improving' },
            // Add more sample data or load from API
        ];
        
        container.innerHTML = students.map(student => `
            <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                <div>
                    <strong>${student.name}</strong>
                    <br>
                    <small class="text-muted">Recent: ${student.recent_score}%</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-${student.trend === 'improving' ? 'success' : student.trend === 'declining' ? 'danger' : 'secondary'}">
                        ${student.trend}
                    </span>
                    <br>
                    <a href="/api/analytics/student/${student.id}" class="btn btn-sm btn-outline-primary mt-1">
                        Details
                    </a>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading student progress:', error);
        container.innerHTML = '<p class="text-muted">Unable to load student progress data.</p>';
    }
}

function refreshAnalytics() {
    location.reload();
}

function exportAnalytics() {
    // Implement CSV export functionality
    const csvData = generateAnalyticsCSV();
    downloadCSV(csvData, 'analytics_report.csv');
}

function generateAnalyticsCSV() {
    // Generate CSV data from current analytics
    return 'Date,Average Score,Essay Count\n' + 
           [{% for date, avg_score in score_trends %}'"{{ date.strftime("%Y-%m-%d") if date else "N/A" }}","{{ avg_score or 0 }}","1"',{% endfor %}].join('\n');
}

function downloadCSV(csvData, filename) {
    const blob = new Blob([csvData], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', filename);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>
{% endblock %}
