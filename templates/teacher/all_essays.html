{% extends "base.html" %}

{% block title %}All Student Essays - AI Essay Coach{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card shadow-lg border-0 sticky-top" style="top: 110px;">
                <div class="card-header bg-gradient-primary text-white py-3">
                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                        <i class="fas fa-chalkboard-teacher me-3"></i>Teacher Portal
                    </h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('teacher.teacher_dashboard') }}" class="list-group-item list-group-item-action border-0 fw-medium">
                        <i class="fas fa-chart-line me-3" style="width: 20px;"></i>Dashboard
                    </a>
                    <a href="{{ url_for('view_submissions') }}" class="list-group-item list-group-item-action border-0 fw-medium">
                        <i class="fas fa-file-alt me-3" style="width: 20px;"></i>Submissions
                    </a>
                    <a href="{{ url_for('teacher_all_essays') }}" class="list-group-item list-group-item-action active border-0 fw-medium">
                        <i class="fas fa-list-alt me-3" style="width: 20px;"></i>All Essays
                    </a>
                    <a href="{{ url_for('student_management') }}" class="list-group-item list-group-item-action border-0 fw-medium">
                        <i class="fas fa-users me-3" style="width: 20px;"></i>Students
                    </a>
                    <a href="{{ url_for('create_assignment') }}" class="list-group-item list-group-item-action border-0 fw-medium">
                        <i class="fas fa-plus-circle me-3" style="width: 20px;"></i>Create Assignment
                    </a>
                    <a href="{{ url_for('teacher_analytics') }}" class="list-group-item list-group-item-action border-0 fw-medium">
                        <i class="fas fa-chart-bar me-3" style="width: 20px;"></i>Analytics
                    </a>
                    <a href="{{ url_for('teacher_profile') }}" class="list-group-item list-group-item-action border-0 fw-medium">
                        <i class="fas fa-user-cog me-3" style="width: 20px;"></i>Settings
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4 animate-fade-in">
                <div>
                    <h2 class="fw-bold mb-2">Student Essays ðŸ“š</h2>
                    <p class="text-secondary mb-0">Review AI-analyzed essays and provide feedback</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('student_management') }}" class="btn btn-outline-primary">
                        <i class="fas fa-users me-2"></i>Manage Students
                    </a>
                    <a href="{{ url_for('create_assignment') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>New Assignment
                    </a>
                </div>
            </div>

            <!-- Essays List -->
            <div class="card border-0 shadow-lg animate-scale-in">
                <div class="card-header bg-gradient-primary text-white py-3">
                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                        <i class="fas fa-file-alt me-3"></i>All Student Essays ({{ essays|length }})
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if essays %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="fw-bold">Student</th>
                                        <th class="fw-bold">Essay Title</th>
                                        <th class="fw-bold">Type</th>
                                        <th class="fw-bold">Submitted</th>
                                        <th class="fw-bold">AI Score</th>
                                        <th class="fw-bold">Status</th>
                                        <th class="fw-bold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for essay in essays %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="rounded-circle me-2 d-flex align-items-center justify-content-center" 
                                                         style="width: 32px; height: 32px; background: var(--accent-gradient);">
                                                        <i class="fas fa-user text-white"></i>
                                                    </div>
                                                    <span class="fw-medium">{{ essay[7] }}</span>
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    <h6 class="mb-1 fw-bold">{{ essay[1] or 'Untitled Essay' }}</h6>
                                                    {% if essay[0] in assignment_context %}
                                                        <small class="text-muted">
                                                            <i class="fas fa-tasks me-1"></i>
                                                            Assignment: {{ assignment_context[essay[0]]['title'] }}
                                                        </small>
                                                    {% else %}
                                                        <small class="text-muted">
                                                            <i class="fas fa-edit me-1"></i>
                                                            Individual submission
                                                        </small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-light text-dark px-2 py-1">
                                                    {{ essay[2]|title or 'General' }}
                                                </span>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    {{ essay[4].strftime('%m/%d/%Y') if essay[4] else 'N/A' }}<br>
                                                    {{ essay[4].strftime('%I:%M %p') if essay[4] else '' }}
                                                </small>
                                            </td>
                                            <td>
                                                {% if essay[3] %}
                                                    <div class="text-center">
                                                        <span class="badge rounded-pill px-3 py-2 fw-bold mb-1" 
                                                              style="background: {% if essay[3] >= 80 %}var(--success-gradient){% elif essay[3] >= 60 %}var(--warning-gradient){% else %}var(--error-gradient){% endif %};">
                                                            {{ "%.1f"|format(essay[3]) }}%
                                                        </span>
                                                        <div>
                                                            <small class="text-muted d-block">
                                                                I: {{ "%.0f"|format(essay[8] or 0) }} 
                                                                O: {{ "%.0f"|format(essay[9] or 0) }} 
                                                                S: {{ "%.0f"|format(essay[10] or 0) }} 
                                                                G: {{ "%.0f"|format(essay[11] or 0) }}
                                                            </small>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <span class="badge bg-secondary rounded-pill px-3 py-2">
                                                        Pending
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column gap-1">
                                                    <span class="badge bg-{% if essay[5] == 'reviewed' %}success{% elif essay[5] == 'analyzed' %}info{% else %}warning{% endif %}">
                                                        {{ essay[5]|title }}
                                                    </span>
                                                    {% if essay[6] %}
                                                        <span class="badge bg-primary px-2 py-1">
                                                            <i class="fas fa-comment me-1"></i>Feedback Given
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-warning px-2 py-1">
                                                            <i class="fas fa-clock me-1"></i>Needs Review
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="btn-group-vertical btn-group-sm">
                                                    <a href="{{ url_for('view_essay', essay_id=essay[0]) }}" 
                                                       class="btn btn-outline-primary mb-1">
                                                        <i class="fas fa-eye me-1"></i>View Essay
                                                    </a>
                                                    {% if essay[6] %}
                                                        <a href="{{ url_for('provide_feedback', essay_id=essay[0]) }}" 
                                                           class="btn btn-outline-success mb-1">
                                                            <i class="fas fa-edit me-1"></i>Edit Feedback
                                                        </a>
                                                    {% else %}
                                                        <a href="{{ url_for('provide_feedback', essay_id=essay[0]) }}" 
                                                           class="btn btn-success mb-1">
                                                            <i class="fas fa-comment me-1"></i>Add Feedback
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No essays found</h6>
                            <p class="text-secondary">Students haven't submitted any essays yet, or you don't have any assigned students.</p>
                            <a href="{{ url_for('student_management') }}" class="btn btn-primary">
                                <i class="fas fa-users me-2"></i>Manage Students
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Summary Statistics -->
            {% if essays %}
                <div class="row g-4 mt-4">
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" 
                                     style="width: 50px; height: 50px; background: var(--primary-gradient);">
                                    <i class="fas fa-file-alt text-white"></i>
                                </div>
                                <div class="fw-bold h5 mb-1">{{ essays|length }}</div>
                                <div class="text-muted small">Total Essays</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" 
                                     style="width: 50px; height: 50px; background: var(--success-gradient);">
                                    <i class="fas fa-chart-line text-white"></i>
                                </div>
                                <div class="fw-bold h5 mb-1">
                                    {% set scored_essays = essays|selectattr('3')|list %}
                                    {% if scored_essays %}
                                        {{ "%.1f"|format((scored_essays|sum(attribute='3')) / scored_essays|length) }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </div>
                                <div class="text-muted small">Average Score</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" 
                                     style="width: 50px; height: 50px; background: var(--info-gradient);">
                                    <i class="fas fa-comment text-white"></i>
                                </div>
                                <div class="fw-bold h5 mb-1">{{ essays|selectattr('6')|list|length }}</div>
                                <div class="text-muted small">With Feedback</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" 
                                     style="width: 50px; height: 50px; background: var(--warning-gradient);">
                                    <i class="fas fa-clock text-white"></i>
                                </div>
                                <div class="fw-bold h5 mb-1">{{ essays|rejectattr('6')|list|length }}</div>
                                <div class="text-muted small">Needs Review</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter and Sort Options -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-2">Quick Filters:</h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="filterEssays('all')">All</button>
                                    <button type="button" class="btn btn-outline-warning" onclick="filterEssays('needs-feedback')">Needs Feedback</button>
                                    <button type="button" class="btn btn-outline-success" onclick="filterEssays('reviewed')">Reviewed</button>
                                    <button type="button" class="btn btn-outline-info" onclick="filterEssays('high-score')">High Scores (80+)</button>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="input-group input-group-sm" style="max-width: 300px; margin-left: auto;">
                                    <input type="text" class="form-control" placeholder="Search essays..." id="essaySearch">
                                    <button class="btn btn-outline-secondary" type="button">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.animate-fade-in {
    animation: fadeIn 0.6s ease-in;
}

.animate-scale-in {
    animation: scaleIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes scaleIn {
    from { transform: scale(0.95); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function filterEssays(filter) {
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        let show = true;
        
        switch(filter) {
            case 'needs-feedback':
                show = row.querySelector('.badge.bg-warning') !== null;
                break;
            case 'reviewed':
                show = row.querySelector('.badge.bg-success') !== null || 
                       row.innerHTML.includes('Edit Feedback');
                break;
            case 'high-score':
                const scoreText = row.querySelector('.badge.rounded-pill')?.textContent;
                if (scoreText) {
                    const score = parseFloat(scoreText.replace('%', ''));
                    show = score >= 80;
                } else {
                    show = false;
                }
                break;
            default:
                show = true;
        }
        
        row.style.display = show ? '' : 'none';
    });
    
    // Update active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

// Search functionality
document.getElementById('essaySearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});
</script>
{% endblock %}
